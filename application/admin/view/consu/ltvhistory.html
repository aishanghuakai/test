<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{$app_name}--Roi Model--GAME BRAIN</title>
	{include file="./static/html/header_common.html" /}
	
	 <style>
	   
	    td{
		  height:30px;
		  padding: 0px !important;
		}
		input[type="text"]{
		  padding: 0px;
		  margin:0px;
		}
		th, td {
         vertical-align: middle !important;
          text-align: center !important;
      }
	  .tarbk{
	    margin:20px auto;
	  }
	  .form-group
	  {
	    float:left;
		margin-left:100px;
	  }
	  .form-group .form-control{
	     text-indent:10px;
	  }

	</style>	
</head>
<body>
    <div id="wrapper" style="background-color:#fff;">
        {include file="./static/html/header.html" /} 
	
		<div class="hw_page_content">
		    <div class="hw_menu_left">
         {include file="./static/html/side.html" /}  
			</div>
		    <div class="hw_content_right">
			  <ul class="search_tab clearfix">
			        <li ><a  href="/admin_consu/historylist?appid={$app_id}">列表</a></li>
			       <li><a  href="/admin_consu/index1?appid={$app_id}">ROI</a></li>
				   <li class="active"><a  href="/admin_consu/ltv?appid={$app_id}">LTV</a></li>
		      </ul>
			  <div class="tarbk">
		                 <div class="form-group">
						    <label for="dau">新增</label>
						    <input type="text" class="form-control" style="width:150px" id="dau" value="{$res.arpdau}">
					     </div>
					     <div class="form-group">
						     <label for="spend">花费</label>
						     <input type="text" class="form-control" style="width:150px" id="spend" value="{$res.cpi}">
					     </div>
						
						<div class="form-group" style="margin-top:23px;">
						    <a class="btn btn-primary" href="javascript:;" id="js" style="float:right;width:150px;">应用</a>
					     </div>					 
				</div>
				 <div style="width:80%;margin:0 auto;">
					 <table class="table table-bordered table-hover">
						
					   <thead>
						  <tr>
							 <th>天数</th>
							 <th>日期</th>
							 <th>ARPDAU</th>
							 <th>留存</th>
							 <th>留存用户</th>
							 <th>eCPM</th>
							 <th>当天收益</th>
							 <th>总收益</th>
							 <th>ROI</th>
						  </tr>
					   </thead>
					   <tbody id="r_model">
						 {$html}					 
					   </tbody>
					</table> 
				  <div style="text-align:center;margin-bottom:30px;">
				    <button type="button" onclick="Roi.save('edit');" style="width:200px;" class="btn btn-warning">修改</button>
					<button type="button"  data-toggle="modal" data-target="#myModal" style="width:200px;" class="btn btn-info">新建</button>
				  </div>
			    </div>
			</div>
		</div>
    {include file="./static/html/footer.html" /}		 
	</div>
   {include file="./static/html/footer_common.html" /}
   
   <div class="modal fade" id="myModal" style="top:10%;" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
       <!--  <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button> -->
        <h4 class="modal-title" id="myModalLabel">设置名称</h4>
      </div>
      <div class="modal-body">
         <input type="text" class="form-control" id="save_name" value="{$res.save_name}">
      </div>
      <div class="modal-footer">       
		 <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
		 <button type="button" class="btn btn-primary" onclick="Roi.save('add');">Save changes</button>
      </div>
    </div>
  </div>
</div>	
</body>
 
  <script>
    $( function(){
	   	   	   
	   $("#js").bind( "click",function(e){
	      
			Roi.allwork();
	   })
	   
	   $(window).scroll(function(){
		        var scroll =$(window).scrollTop();
				if(scroll > 100){
					$("#topp").show('slow');
				}else{
					$("#topp").hide('slow');
				}
			})
	})
    //初始化 数据模型  by lxf
    var Roi = window.Roi || {};
	
	  ( function(){
	     
		 var dau ="";
		 var spend ="";
		 var a_index = false;
		 
		 var update = function()
		 {
		    dau = $("#dau").val();
			spend = $("#spend").val();
		 }
		 
	     this.check = function()
		 {
		     update();
			 if( !dau || !spend )
			 {
			    layer.msg("新增,花费不能为空");return false;
			 }
			 return true;
		 }
		//单个数据核心处理计算
		Roi.init = function()
		{
	    		
			var _that = this;
			$('.arpdau').bind('input propertychange', function()
		   {
			   let lc = $(this).parents("tr").find(".lc").val();
			   if(_that.check() && lc )
			   {				  
                  _that.allwork();				  
			   }				  
		   });
		   $('.lc').bind('input propertychange', function()
		   {
			   let ad = $(this).parents("tr").find(".arpdau").val();
			   if(_that.check() && ad )
			   {				  
                  _that.allwork();				  
			   }				  
		   });
		}
		
		//计算核心
		Roi.work = function(t,sum_roi,users)
		{
			var total_sum_roi = sum_roi;
			t.parents("tr").prevAll().each(function(i)
				{
					 let _$lc = $(this).find(".lc");
					 let arpdau =$(this).find(".arpdau").val(); 
					 let _m_sum = _$lc.val();
					 let one_revenue = (arpdau*dau*_m_sum)/100;
					 total_sum_roi+=parseFloat(one_revenue);
				});
			 this.show( t,total_sum_roi,sum_roi,users);
		}
		//重新整个计算
		Roi.allwork = function()
		{
		  
		   var _that = this;
		   if(_that.check())
			   {					
					$("#r_model tr").each(function(i)
					{
						 let _$lc = $(this).find(".lc");
						 let arpdau =$(this).find(".arpdau").val(); 
						 let _m_sum = _$lc.val();
						 let one_revenue = (arpdau*dau*_m_sum)/100;
						 let sum_roi =parseFloat(one_revenue);
						 let users = Math.round(dau*_m_sum/100);
						 _that.work(_$lc,sum_roi,users);					
					});
		       }	
		}
	 	 // 数据渲染 
		 Roi.show = function( t,total_sum_roi,sum_roi,users)
		 {
		    if( t.val()=="0" )sum_roi=0;
			
			var show_roi_num =parseFloat((total_sum_roi/spend)*100).toFixed(2);
			t.parents("tr").find(".revenu").text(parseFloat(total_sum_roi).toFixed(2));
			t.parents("tr").find(".todayrevenu").text(parseFloat(sum_roi).toFixed(2));
			t.parents("tr").find(".roi").text(show_roi_num);
			t.parents("tr").find(".users").text(users);
			if( show_roi_num<100 )
			{
			   t.parents("tr").css({"background-color":"#fff","font-weight":"normal"});
			   a_index=false;
			}
			if( show_roi_num>=100 && !a_index )
			{
			    a_index=true;  //重置当前
				t.parents("tr").css( {
				   "background-color":"#ee6e73",
				   "font-weight":"bold"
				});
			}
			
		 }
		 
		 //数据保存
		 Roi.save = function(model)
		 {
		    update();
			var data = [];
			$("#r_model tr").each(function(i)
			{
				 var lc = $(this).find(".lc").val();
				 var arpdau = $(this).find(".arpdau").val();
				 var todayrevenu = $(this).find(".todayrevenu").text();
				 var date = $(this).find("td").eq(0).text();
				 var time = $(this).find("td").eq(1).text();
				 var ecpm = $(this).find(".ecpm").text();
				 var revenu = $(this).find(".revenu").text();
                 var users = $(this).find(".users").text();
                 var roi_rate = $(this).find(".roi").text();	
                 data[i] = { lc:lc,date:date,time:time,ecpm:ecpm,revenu:revenu,roi_rate:roi_rate,arpdau:arpdau,todayrevenu:todayrevenu,users:users };				 
			});
			var save_name = $("#save_name").val();
			if( save_name=="" )
			{
			  layer.msg("保存名称不能为空");return false;
			}
			var id = "<?php echo $id; ?>";
			$("#save").attr("disabled",true);
			var index = layer.load(0, {shade: false});
			$('#myModal').modal('hide');
			$.post("/admin_consu/save",{ id:id,type:2,arpdau:dau,cpi:spend,model:model,data:data,save_name:save_name,appid:'<?php echo $app_id; ?>' },function(e){
			
			        $("#save").attr("disabled",false);
			        layer.close(index);					
			        layer.alert('数据已保存');
					window.location.href=window.location.href;
			})
		 }
		 
	  }.call(Roi) );
	  
	 //Roi.init();
	 
</script>
</html>
