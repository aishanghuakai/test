<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>财务管理</title>
  {include file="./static/html/fheader_common.html" /}
  <style>
     .ivu-tabs.ivu-tabs-card > .ivu-tabs-bar .ivu-tabs-tab{
        border-radius: 0;
        background: #fff;
    }
    .ivu-tabs.ivu-tabs-card > .ivu-tabs-bar .ivu-tabs-tab-active{
        border-top: 1px solid #3399ff;
    }
    .ivu-tabs.ivu-tabs-card > .ivu-tabs-bar .ivu-tabs-tab-active:before{
        content: '';
        display: block;
        width: 100%;
        height: 1px;
        background: #3399ff;
        position: absolute;
        top: 0;
        left: 0;
    }
	.fullscreen{
	  width:100% !important;
	  margin-left:0px !important;
	  height:100% !important;
	  position:fixed !important;
	  margin-top:0px !important;
	  z-index:9999
	}
	.ivu-badge-dot{z-index:0;}
	.red{color:#f38181;font-size:14px;}
	.ivu-input[disabled]{background:#fff;color:#515a6e}
	.ivu-input{height:auto;border:none;text-align:center;}
	.ivu-table-cell{font-size:12px;}
	.checkaftercolor .ivu-input{color:#515a6e;}
	.checkbeforecolor .ivu-input{color:#ffaf00;}
  </style>
</head>
<body>
   <div id="wrapper">
        {include file="./static/html/fheader.html" /}	
		<div class="hw_page_content">
		  <div class="hw_menu_left">
		     {include file="./static/html/fside.html" /}
		  </div>	 
		    <div class="hw_content_right" style="padding:10px 10px;">
			
			   <div style="padding:5px 0px 20px 0px;">
				  <Breadcrumb separator=">">
					 
					  <breadcrumb-item to="/testplan/payment">付款管理</breadcrumb-item>
					 
					</Breadcrumb>
				</div>
			  <Tabs value="2019" type="card" style="clear:both" @on-click="loadData">
						
						<Tab-pane label="2019年" name="2019">						   
							<i-table ref="table" border disabled-hover @on-selection-change="handleSelect" :loading="loading" max-height="400" :columns="report_columns" :data="report_data"></i-table>					
						</Tab-pane>
						<Tab-pane label="2018年 " name="2018">
						  <i-table ref="table" border disabled-hover @on-selection-change="handleSelect" :loading="loading" max-height="400" :columns="report_columns" :data="report_data"></i-table>
						</Tab-pane>
						<Tab-pane label="2017年" name="2017">
						  <i-table ref="table" border disabled-hover @on-selection-change="handleSelect" :loading="loading" max-height="400" :columns="report_columns" :data="report_data"></i-table>
						</Tab-pane>
						
						{if condition="$role eq 'financer'"}
						 <i-button type="primary" style="margin-right:8px;" @click="review" slot="extra">复核更正</i-button>
						{else /}
						<i-button type="info" style="margin-right:8px;"  slot="extra" @click="save">保存</i-button>
						{/if}
						<i-button type="dashed"  slot="extra" @click="openModal"><Icon type="ios-add" /></Icon> 添加</i-button>
			  </Tabs>
			  <Page :total="100" :page-size="30" style="margin-top:10px;" />
			</div>
		</div>
		<Modal v-model="modal1" title="添加行" >
						
							<Row :gutter="32">
							   <i-col span="12">
                              <h5 style="padding:5px 0px;">渠道</h5>
							  <i-select v-model="channel" filterable style="width:200px">
                                 {volist name="channel" id="c"}
								  <i-option  value="{$c.id}" key="{$c.id}">{$c.name}</i-option>	
                                 {/volist}								 
                              </i-select>
							 </i-col>								
							 <i-col span="12">
								 <h5 style="padding:5px 0px;">产品</h5>
								  <i-select v-model="product" filterable style="width:200px">
									 {volist name="product" id="p"}
								      <i-option  value="{$p.id}" key="{$c.id}">{$p.name}</i-option>	
                                     {/volist}
								  </i-select>
							  </i-col>
							</Row> 
							<div slot="footer"> 
							  <i-button type="text" size="large" @click="modal1=false">取消</i-button> 
							  <i-button type="primary" size="large" @click="addRow" >确定</i-button> 
							</div>
						
		</Modal>
    </div>		
</body>
{include file="./static/html/footer_common.html" /}
</html>
 <script>
    
     var t = new Vue({
        el: '#wrapper',
        data: {
			
			modal1:false,
		    loading:false,
			year:"2019",
			inputData:[],
			isreview:0,
			product:"",
			channel:"",
			selectData:[],
			report_columns: [
			        {
                        type: 'selection',
                        width: 60,
						fixed: 'left',
                        align: 'center'
                    },
					{
                        title: '渠道名称',
                        key: 'channel',
						width: 150,
						align:'center',
						fixed: 'left'
                    },
					{
                        title: '产品名称',
						width: 200,
						align:'center',
                        key: 'product',
						fixed: 'left'
                    },                  
                    {
                        title: '币种',
						width: 100,
						align:'center',
                        key: 'currency',
						fixed: 'left'
                    },
					{
                        title: '1月',
						width: 120,
						align:'center',
                        key: 'month_01',
						render: (h, params) => {
                            
							var arr = params.row.month_01.editlog;//数据数组 
							var newArr = [];
							arr.forEach((a,index)=>{ newArr.push(h('div',[ h('h5',a.time),h('strong',{ class:'red' },a.updateuser),h('span', "  将"+a.content) ])) })							
							return  h('Tooltip',{  props:{ placement:"top-start",disabled:params.row.month_01.isedit,transfer:true } },[							     
								 h('div', {
                                    slot: 'content'
                                 },newArr),								 
                                 h('i-input',{ props:{ value:params.row.month_01.val,disabled:params.row.month_01.isinput },on:{ input:(val)=>{ let map = t.inputData[params.index] || {};map["product_id"] =params.row.product_id;map["channel_id"] =params.row.channel_id; map["month_01"]=val;t.inputData[params.index] =map;  } },class:params.row.month_01.class },params.row.month_01.val),
                                h('Badge',{ props:{ dot:!params.row.month_01.isedit,offset:[-12,-10] } },'')
						   ]);						
                        }
                    },
					{
                        title: '2月',
						width: 120,
						align:'center',
                        key: 'month_02',
						render: (h, params) => {
                            var arr = params.row.month_02.editlog;//数据数组 
							var newArr = [];
							arr.forEach((a,index)=>{ newArr.push(h('div',[ h('h5',a.time),h('strong',{ class:'red' },a.updateuser),h('span', "  将"+a.content) ])) })							
							return  h('Tooltip',{  props:{ placement:"top-start",disabled:params.row.month_02.isedit,transfer:true } },[							     
								 h('div', {
                                    slot: 'content'
                                 },newArr),								 
                                 h('i-input',{ props:{ value:params.row.month_02.val,disabled:params.row.month_02.isinput },on:{ input:(val)=>{ let map = t.inputData[params.index] || {};map["product_id"] =params.row.product_id;map["channel_id"] =params.row.channel_id; map["month_02"]=val;t.inputData[params.index] =map;  } },class:params.row.month_02.class },params.row.month_02.val),
                                h('Badge',{ props:{ dot:!params.row.month_02.isedit,offset:[-12,-10] } },'')
						   ]);						
                        }
                    },
					{
                        title: '3月',
						width: 120,
						align:'center',
                        key: 'month_03',
						render: (h, params) => {
                            var arr = params.row.month_03.editlog;//数据数组 
							var newArr = [];
							arr.forEach((a,index)=>{ newArr.push(h('div',[ h('h5',a.time),h('strong',{ class:'red' },a.updateuser),h('span', "  将"+a.content) ])) })							
							return  h('Tooltip',{  props:{ placement:"top-start",disabled:params.row.month_03.isedit,transfer:true } },[							     
								 h('div', {
                                    slot: 'content'
                                 },newArr),								 
                                 h('i-input',{ props:{ value:params.row.month_03.val,disabled:params.row.month_03.isinput },on:{ input:(val)=>{ let map = t.inputData[params.index] || {};map["product_id"] =params.row.product_id;map["channel_id"] =params.row.channel_id; map["month_03"]=val;t.inputData[params.index] =map;  } },class:params.row.month_03.class },params.row.month_03.val),
                                h('Badge',{ props:{ dot:!params.row.month_03.isedit,offset:[-12,-10] } },'')
						   ]);					
                        }
                    },
					{
                        title: '4月',
						width: 120,
						align:'center',
                        key: 'month_04',
						render: (h, params) => {
                            var arr = params.row.month_04.editlog;//数据数组 
							var newArr = [];
							arr.forEach((a,index)=>{ newArr.push(h('div',[ h('h5',a.time),h('strong',{ class:'red' },a.updateuser),h('span', "  将"+a.content) ])) })							
							return  h('Tooltip',{  props:{ placement:"top-start",disabled:params.row.month_04.isedit,transfer:true } },[							     
								 h('div', {
                                    slot: 'content'
                                 },newArr),								 
                                 h('i-input',{ props:{ value:params.row.month_04.val,disabled:params.row.month_04.isinput },on:{ input:(val)=>{ let map = t.inputData[params.index] || {};map["product_id"] =params.row.product_id;map["channel_id"] =params.row.channel_id; map["month_04"]=val;t.inputData[params.index] =map;  } },class:params.row.month_04.class },params.row.month_04.val),
                                h('Badge',{ props:{ dot:!params.row.month_04.isedit,offset:[-12,-10] } },'')
						   ]);					
                        }
                    },
					{
                        title: '5月',
						width: 120,
						align:'center',
                        key: 'month_05',
						render: (h, params) => {
                            var arr = params.row.month_05.editlog;//数据数组 
							var newArr = [];
							arr.forEach((a,index)=>{ newArr.push(h('div',[ h('h5',a.time),h('strong',{ class:'red' },a.updateuser),h('span', "  将"+a.content) ])) })							
							return  h('Tooltip',{  props:{ placement:"top-start",disabled:params.row.month_05.isedit,transfer:true } },[							     
								 h('div', {
                                    slot: 'content'
                                 },newArr),								 
                                 h('i-input',{ props:{ value:params.row.month_05.val,disabled:params.row.month_05.isinput },on:{ input:(val)=>{ let map = t.inputData[params.index] || {};map["product_id"] =params.row.product_id;map["channel_id"] =params.row.channel_id; map["month_05"]=val;t.inputData[params.index] =map;  } },class:params.row.month_05.class },params.row.month_05.val),
                                h('Badge',{ props:{ dot:!params.row.month_05.isedit,offset:[-12,-10] } },'')
						   ]);						
                        }
                    },
					{
                        title: '6月',
						width: 120,
						align:'center',
                        key: 'month_06',
						render: (h, params) => {
                            var arr = params.row.month_06.editlog;//数据数组 
							var newArr = [];
							arr.forEach((a,index)=>{ newArr.push(h('div',[ h('h5',a.time),h('strong',{ class:'red' },a.updateuser),h('span', "  将"+a.content) ])) })							
							return  h('Tooltip',{  props:{ placement:"top-start",disabled:params.row.month_06.isedit,transfer:true } },[							     
								 h('div', {
                                    slot: 'content'
                                 },newArr),								 
                                 h('i-input',{ props:{ value:params.row.month_06.val,disabled:params.row.month_06.isinput },on:{ input:(val)=>{ let map = t.inputData[params.index] || {};map["product_id"] =params.row.product_id;map["channel_id"] =params.row.channel_id; map["month_06"]=val;t.inputData[params.index] =map;  } },class:params.row.month_06.class },params.row.month_06.val),
                                h('Badge',{ props:{ dot:!params.row.month_06.isedit,offset:[-12,-10] } },'')
						   ]);						
                        }
                    },
					{
                        title: '7月',
						width: 120,
						align:'center',
                        key: 'month_07',
						render: (h, params) => {
                            var arr = params.row.month_07.editlog;//数据数组 
							var newArr = [];
							arr.forEach((a,index)=>{ newArr.push(h('div',[ h('h5',a.time),h('strong',{ class:'red' },a.updateuser),h('span', "  将"+a.content) ])) })							
							return  h('Tooltip',{  props:{ placement:"top-start",disabled:params.row.month_07.isedit,transfer:true } },[							     
								 h('div', {
                                    slot: 'content'
                                 },newArr),								 
                                 h('i-input',{ props:{ value:params.row.month_07.val,disabled:params.row.month_07.isinput },on:{ input:(val)=>{ let map = t.inputData[params.index] || {};map["product_id"] =params.row.product_id;map["channel_id"] =params.row.channel_id; map["month_07"]=val;t.inputData[params.index] =map;  } },class:params.row.month_07.class },params.row.month_07.val),
                                h('Badge',{ props:{ dot:!params.row.month_07.isedit,offset:[-12,-10] } },'')
						   ]);						
                        }
                    },
					{
                        title: '8月',
						width: 120,
						align:'center',
                        key: 'month_08',
						render: (h, params) => {
                            var arr = params.row.month_08.editlog;//数据数组 
							var newArr = [];
							arr.forEach((a,index)=>{ newArr.push(h('div',[ h('h5',a.time),h('strong',{ class:'red' },a.updateuser),h('span', "  将"+a.content) ])) })							
							return  h('Tooltip',{  props:{ placement:"top-start",disabled:params.row.month_08.isedit,transfer:true } },[							     
								 h('div', {
                                    slot: 'content'
                                 },newArr),								 
                                 h('i-input',{ props:{ value:params.row.month_08.val,disabled:params.row.month_08.isinput },on:{ input:(val)=>{ let map = t.inputData[params.index] || {};map["product_id"] =params.row.product_id;map["channel_id"] =params.row.channel_id; map["month_08"]=val;t.inputData[params.index] =map;  } },class:params.row.month_08.class },params.row.month_08.val),
                                h('Badge',{ props:{ dot:!params.row.month_08.isedit,offset:[-12,-10] } },'')
						   ]);						
                        }
                    },
					{
                        title: '9月',
						width: 120,
						align:'center',
                        key: 'month_09',
						render: (h, params) => {
                            var arr = params.row.month_09.editlog;//数据数组 
							var newArr = [];
							arr.forEach((a,index)=>{ newArr.push(h('div',[ h('h5',a.time),h('strong',{ class:'red' },a.updateuser),h('span', "  将"+a.content) ])) })							
							return  h('Tooltip',{  props:{ placement:"top-start",disabled:params.row.month_09.isedit,transfer:true } },[							     
								 h('div', {
                                    slot: 'content'
                                 },newArr),								 
                                 h('i-input',{ props:{ value:params.row.month_09.val,disabled:params.row.month_09.isinput },on:{ input:(val)=>{ let map = t.inputData[params.index] || {};map["product_id"] =params.row.product_id;map["channel_id"] =params.row.channel_id; map["month_09"]=val;t.inputData[params.index] =map;  } },class:params.row.month_09.class },params.row.month_09.val),
                                h('Badge',{ props:{ dot:!params.row.month_09.isedit,offset:[-12,-10] } },'')
						   ]);						
                        }
                    },
					{
                        title: '10月',
						width: 120,
						align:'center',
                        key: 'month_10',
						render: (h, params) => {
                            var arr = params.row.month_10.editlog;//数据数组 
							var newArr = [];
							arr.forEach((a,index)=>{ newArr.push(h('div',[ h('h5',a.time),h('strong',{ class:'red' },a.updateuser),h('span', "  将"+a.content) ])) })							
							return  h('Tooltip',{  props:{ placement:"top-start",disabled:params.row.month_10.isedit,transfer:true } },[							     
								 h('div', {
                                    slot: 'content'
                                 },newArr),								 
                                 h('i-input',{ props:{ value:params.row.month_10.val,disabled:params.row.month_10.isinput },on:{ input:(val)=>{ let map = t.inputData[params.index] || {};map["product_id"] =params.row.product_id;map["channel_id"] =params.row.channel_id; map["month_10"]=val;t.inputData[params.index] =map;  } },class:params.row.month_10.class },params.row.month_10.val),
                                h('Badge',{ props:{ dot:!params.row.month_10.isedit,offset:[-12,-10] } },'')
						   ]);						
                        }
                    },
					{
                        title: '11月',
						width: 120,
						align:'center',
                        key: 'month_11',
						render: (h, params) => {
                            var arr = params.row.month_11.editlog;//数据数组 
							var newArr = [];
							arr.forEach((a,index)=>{ newArr.push(h('div',[ h('h5',a.time),h('strong',{ class:'red' },a.updateuser),h('span', "  将"+a.content) ])) })							
							return  h('Tooltip',{  props:{ placement:"top-start",disabled:params.row.month_11.isedit,transfer:true } },[							     
								 h('div', {
                                    slot: 'content'
                                 },newArr),								 
                                 h('i-input',{ props:{ value:params.row.month_11.val,disabled:params.row.month_11.isinput },on:{ input:(val)=>{ let map = t.inputData[params.index] || {};map["product_id"] =params.row.product_id;map["channel_id"] =params.row.channel_id; map["month_11"]=val;t.inputData[params.index] =map;  } },class:params.row.month_11.class },params.row.month_11.val),
                                h('Badge',{ props:{ dot:!params.row.month_11.isedit,offset:[-12,-10] } },'')
						   ]);					
                        }
                    },
					{
                        title: '12月',
						width: 120,
						align:'center',
                        key: 'month_12',
						render: (h, params) => {
                            var arr = params.row.month_12.editlog;//数据数组 
							var newArr = [];
							arr.forEach((a,index)=>{ newArr.push(h('div',[ h('h5',a.time),h('strong',{ class:'red' },a.updateuser),h('span', "  将"+a.content) ])) })							
							return  h('Tooltip',{  props:{ placement:"top-start",disabled:params.row.month_12.isedit,transfer:true } },[							     
								 h('div', {
                                    slot: 'content'
                                 },newArr),								 
                                 h('i-input',{ props:{ value:params.row.month_12.val,disabled:params.row.month_12.isinput },on:{ input:(val)=>{ let map = t.inputData[params.index] || {};map["product_id"] =params.row.product_id;map["channel_id"] =params.row.channel_id; map["month_12"]=val;t.inputData[params.index] =map;  } },class:params.row.month_12.class },params.row.month_12.val),
                                h('Badge',{ props:{ dot:!params.row.month_12.isedit,offset:[-12,-10] } },'')
						   ]);					
                        }
                    }				
                ],
                report_data: []
        },
		watch: {
			 
        },
		mounted(){		 
		  	
			this.getdata()  
		},
        methods: {
            addRow(){
				axios({
						method: 'post',
						url:'/finance/addRow',
						data:{
						   channel:this.channel,
						   type:2,
						   year:this.year,
						   product:this.product
						}
					}).then(res=>{
					 window.location.href = window.location.href
				 })
			},
			save(){
			  
			  if( this.selectData.length<1 )
			  {
			     this.$Message.warning('请勾选需要保存的行');
				 return;
			  }
			  let _that = this
			  axios({
						method: 'post',
						url:'/finance/saveData',
						data:{
						   inputData:this.inputData,
						   year:this.year,
						   type:2,
						   selectData:this.fiterMap(this.selectData)
						}
					}).then(res=>{
					 this.$Message.success('操作成功');					
					 window.location.href = window.location.href
				 })
			},
			
			review()
			{
				  if( this.selectData.length<1 )
				  {
					 this.$Message.warning('请勾选需要复核更正的行');
					 return;
				  }
				  axios({
						method: 'post',
						url:'/finance/reviewData',
						data:{
						   inputData:this.inputData,
						   year:this.year,
						   type:2,
						   selectData:this.fiterMap(this.selectData)
						}
					}).then(res=>{
					 this.$Message.success('操作成功');					
					 window.location.href = window.location.href
				 })
			},
			handleSelect(rows){
			  this.selectData = rows
			},
			fiterMap(data){
		      return data.map(function (t) {
					  return {
						channel_id:t.channel_id,
						product_id:t.product_id,
						hash:t.channel_id+"#"+t.product_id
					  }
				})
		   },
		   fiterReview(data){
		     return data.map(function (t) {
					   t['hash'] = t.channel_id+"#"+t.product_id
					  return t
				})
		   },
			getdata()
		   {
		     let _that = this
			 this.loading  =true
			 axios.get('/finance/getData?year='+this.year+"&type=2")
			  .then(function (response) {
				  _that.loading  =false
				 _that.report_data = response.data
			  })
			  .catch(function (error) {
				console.log(error);
			  });
		   },
		   openModal(){
		     this.modal1 = true
			 this.product = ""
			 this.channel =""
		   },
			exportData(){
			 this.$refs.table.exportCsv({
                        filename: 'The original data'
                    });
			},
			loadData(name)
			{
			   this.year = name
               this.getdata()			   
			},
			handleChange (date) {
                this.date = date;
           }
        }
    })
  </script>


